# ProbShakemaps

The **ProbShakemaps** is an open source Python toolbox that generates a probabilistic version of the traditional [Shakemaps](https://github.com/DOI-USGS/ghsc-esi-shakemap). 

Dependencies
-----------------------------

 * All [Shakemap](https://github.com/DOI-USGS/ghsc-esi-shakemap) and [OpenQuake](https://github.com/gem/oq-engine/blob/master/README.md) dependencies
 * basemap
 * seaborn
 
 For more details, check `requirements.txt` for a list of all the installed Python packages and their versions.
 
Command line usage
------------------
<pre>
usage: ProbShakemaps.py [-h] --task {RunProbAnalysis,GenerateProbShakemap} [--imt {PGA,PGV}] 
                        [--tool {StationRecords,QueryHDF5,GetStatistics,EnsemblePlot}] [--imt_min IMT_MIN] 
                        [--imt_max IMT_MAX] [--station_file STATION_FILE] [--scenario SCENARIO] [--pois_file POIS_FILE] 
                        [--ensemble_number ENSEMBLE_NUMBER] [--deg-round DEG_ROUND] [--pois_subset] [--n_pois N_POIS]
                        [--max_distance MAX_DISTANCE] [--pois_selection_method {random,azimuth_uniform}] 
                        [--fileScenariosWeights FILESCENARIOSWEIGHTS]

ProbShakemap Toolbox

optional arguments:
  -h, --help            show this help message and exit

input params:
  --task {RunProbAnalysis,GenerateProbShakemap}
                        Task to perform
  --imt {PGA,PGV}       Intensity measure type (IMT)
  --tool {StationRecords,QueryHDF5,GetStatistics,EnsemblePlot}
                        Tool to use
  --imt_min IMT_MIN     Minimum value for the selected IMT (for plot only)
  --imt_max IMT_MAX     Maximum value for the selected IMT (for plot only)
  --station_file STATION_FILE
                        Shakemap .json station file
  --scenario SCENARIO   Scenario number
  --pois_file POIS_FILE
                        Filename with latitude and longitude of POIs
  --ensemble_number ENSEMBLE_NUMBER
                        Ensemble sample number
  --deg-round DEG_ROUND
                        Rounding precision for latitude and longitude
  --pois_subset         Extract a subset of POIs
  --n_pois N_POIS       Number of POIs in the subset
  --max_distance MAX_DISTANCE
                        Max distance from epicenter of POIs in the subset
  --pois_selection_method {random,azimuth_uniform}
                        Selection method for the POIs of the subset
  --fileScenariosWeights FILESCENARIOSWEIGHTS
                        File with scenarios weights
</pre>                        
            
            
Usage
------------------

**RUN PROBABILISTIC ANALYSIS**

```bash
python ProbShakemaps.py --task RunProbAnalysis
```

OUTPUT

`SIZE_{num_scenarios}_ENSEMBLE_{num_ensemble}_{imt}.hdf5`: HDF5 file generated by the probabilistic analysis. Each POI is assigned an IMT distribution including as many values as the number of GMPEs realizations chosen by the user.

`params.jso`: File with parameters required by the ProbShakemaps tools

***************************************

**GENERATE PROBSHAKEMAPS**

**TOOL: 'StationRecords'**

Inspect Shakemap .json station file

```bash
python ProbShakemaps.py --task GenerateProbShakemap --tool StationRecords --imt PGA --imt_min 0.01 --imt_max 10 --station_file stationlist.json
```
OUTPUT

`Data_stationfile_{imt}.png`: Plot data from Shakemap .json station file for the selected IMT (PGA in the example).

<p align="center">
    <img src="https://github.com/angystallone/ProbShakemaps/blob/main/OUTPUT_REPO/Data_stationfile_PGA.png" alt="Data_stationfile_PGA.png" width="60%" height="60%">
</p>

**TOOL: 'QueryHDF5'**

Navigate and query the .HDF5 file 

```bash
python ProbShakemaps.py --task GenerateProbShakemap --tool QueryHDF5 --imt PGA --scenario 50 --pois_file POIs.txt
```

OUTPUT

`GMF_info.txt`: Print the ground motion fields for the selected scenario at the POIs listed in `POIs.txt`.

Preview of the output file:
<pre>
GMF realizations at Site_LAT:43.2846_LON:12.7778 for Scenario_10: [0.17520797, 0.21844997, 0.093965515, 0.27266037, 0.079073295, 0.09725358, 0.08347481, 0.06693749, 0.005907976, 0.060873847]
GMF realizations at Site_LAT:43.1846_LON:12.8778 for Scenario_10: [0.100996606, 0.35003924, 0.24363522, 0.19941418, 0.15757227, 0.1009447, 0.19146584, 0.06460667, 0.03146108, 0.097111605]
GMF realizations at Site_LAT:43.0846_LON:13.4778 for Scenario_10: [0.18333985, 0.11954803, 0.2914887, 0.050770156, 0.07628956, 0.17871241, 0.10297835, 0.15162756, 0.020328628, 0.04087482]
</pre>

**TOOL: 'GetStatistics'**

* Calculates and save statistics ('Mean','Mean','Median','Percentile 10','Percentile 20','Percentile 80','Percentile 90'). If the user does not provide a file with scenarios weights, they are considered equally probable.
* Plots calculated statistics at each POI.
* Plots the IMT cumulative distribution and main statitics at a specific POI together with the estimated IMT value at the closest station (datum taken from the Shakemap .json station file). Note: the IMT cumulative distribution is based an all scenarios in the ensemble.

```bash
python ProbShakemaps.py --task GenerateProbShakemap --tool GetStatistics --imt PGA --imt_min 0.01 --imt_max 10 --station_file stationlist.json --pois_file POIs.txt
```

OUTPUT

* npy files with statistics saved in the `npyFiles` folder
* Statitics map distributions saved in the `STATISTICS` folder

<p align="center">
    <img src="https://github.com/angystallone/ProbShakemaps/blob/main/OUTPUT_REPO/STATISTICS/summary_stats_forReadMe.png" alt="SummaryStats" width="85%" height="85%">
</p>

* Plot of Datum-Ensemble comparison at each POI saved in the `DISTRIBUTIONS` folder

<p align="center">
    <img src="https://github.com/angystallone/ProbShakemaps/blob/main/OUTPUT_REPO/DISTRIBUTIONS/Distr_POI-003.png" alt="DatumEnsemble" width="80%" height="80%">
</p>

**TOOL: 'EnsemblePlot'**

Summarize the IMT distribution at the selected POIs with a boxplot. Note: the IMT distribution is based an all scenarios in the ensemble.

```bash
python ProbShakemaps.py --task GenerateProbShakemap --tool EnsemblePlot --imt PGA --pois_file POIs.txt
```
OUTPUT

`POIs_Map.pdf`: Spatial map of the POIs

`Ensemble_Spread_Plot_{imt}.pdf`: Boxplot

<p align="center">
    <img src="https://github.com/angystallone/ProbShakemaps/blob/main/OUTPUT_REPO/summary_stats_forReadMe.png" alt="DatumEnsemble" width="80%" height="80%">
</p>

**********************************

NOTE

When using the tools 'QueryHDF5', 'GetStatistics' and 'EnsemblePlot', the user can also require to extract a subset of POIs within a maximum distance from the event epicenter following one of these two possible spatial distributions: <ins>random</ins> and <ins>azimuthally uniform</ins>. This changes the command line to ('GetStatistics' example):

```bash
python ProbShakemaps.py --task GenerateProbShakemap --tool GetStatistics --imt PGA --imt_min 0.01 --imt_max 10 --station_file stationlist.json --pois_file POIs.txt --pois_subset n_pois 10 max_distance 50 --pois_selection_method azimuth_uniform
```


License
-----------------------------

This project is released under the [MIT License](LICENSE).
